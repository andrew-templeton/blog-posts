### What's in the Magic

A Ruby on Rails templated stack generator, running in Amazon Web Services, that provides:

- Application tier
  - Load balanced
    - Elastically scaled
    - Multi AZ for high availability 
    - Ruby version 2.1.5 on each instance
- Database
  - Point-and-click scaling
    - Multi AZ synchronous replication for high availability
    - Postgres engine
    - Automated periodic point-in-time backups
- Auxiliary Services
  - Persistent, distributed filestore with AWS S3
    - High deliverability transactional emails with AWS SES
    - Redis ley-value cache resources
- Deployment
  - Single-form launch of all services
    - Passkeys/tokens omitted from codebases
    - Automated connection of all services
    - Automated low-tier deploys from Git
    - Point-click promotions to production
- Monitoring
  - Stats on API latency, CPU, network I/O
    - Self-healing of application nodes on failed health checks
    - Email notifications on deploy, health, scaling events

### Launching a new environment

1. Click here to deploy the stack: MAGIC LINK
2. Fill out the form you are presented with, confirm everything.
3. Wait until the CloudFormation console says the stack is done.
4. Go to the SOME MAGIC LINK, Werkcer
5. Hit "Add Deploy Target", have "Outputs" from CloudFormation handy
  a. Pick a descriptive environment name  
  b. Add any auto-deploy branch trigger(s) needed  
  c. Enter CloudFormation output `AWSAPPLICATIONNAME` as `AWS_APPLICATION_NAME`
  d. Enter CloudFormation output `AWSENVIRONMENTNAME` as `AWS_ENVIRONMENT_NAME`


### Deploying into an environment

#### Triggering 
###### Manually; Point-click
1. Go to SOME MAGIC LINK
2. Click a passing build
3. Click "Deploy To" in the top right corner, select env, confirm.


###### Automatically; from `git push`

Simply push into a branch set up for auto deploys, and wait.

#### Confirming

Wercker deploys will progress through their steps on SOME MAGIC LINK. When the build "passed" in Wercker, this only means that AWS Elastic Beanstalk has accepted the bundle for graduated rollout to nodes in the environment. To watch for full deploy completion:

1. Go to [the Elastic Beanstalk Application listings page](https://console.aws.amazon.com/elasticbeanstalk/home?region=us-east-1#/applications?applicationNameFilter=)
2. Click on the environment you want to check up on
3. Green means done, Gray means progressing, Red means total failure
4. Events below the status may provide step-by-step insights

### Monitoring

1. Go to [the Elastic Beanstalk Application listings page](https://console.aws.amazon.com/elasticbeanstalk/home?region=us-east-1#/applications?applicationNameFilter=)
2. Click on the environment you want to check up on.....:
###### Statistics
3. Click "Monitoring" on the left hand side
4. You will see graphs. To drill down, click a graph.

###### Logs
3. Click "Logs" on the left hand side
4. Click the "Request Logs" dropdown in the upper right
5. Select a batch size option.
6. Wait. The logs will appear on this screen. 
7. Click the instance ID for which you would like to view pulled logs.


### SSH/DB Access

###### Prep
1. Go to the [AWS EC2 Instance listing page](https://console.aws.amazon.com/ec2/v2/home?region=us-east-1#Instances:sort=instanceId)
2. Find an instance with a Public IP that matches the environment you want to tunnel into (by checking tags/descriptions)
3. Make note of the instance public IP (later `$PUBLIC_IP`)
4. Find an instance in the same VPC with no public IP
5. Note the instance private IP (later `$PRIVATE_IP`)
6. Note the name and path of SSH key (later `$PEM` and `$PEM_PATH`)

###### SSH Tunnel

    scp -i $PEM_PATH $PEM_PATH ec2-user@$PUBLIC_IP:~/.ssh/;
    ssh -i $PEM_PATH ec2-user@$PUBLIC_IP;
    # now you're in first firewall layer node
    chmod 400 ~/.ssh/$PEM
    ssh -i ~/.ssh/$PEM $PRIVATE_IP
    # now you're in the box
    
###### Getting into Postgres

Run this from within a Rails node:

  psql -d $DB_NAME -h $DB_URL -p $DB_PORT -U $DB_USER;
  # Pass is $DB_PASS
    
###### Getting into Redis

This gets you a Redis endpoint when run from a Rails box:

  aws --region us-east-1 elasticache describe-cache-clusters --cache-cluster-id $REDIS_IDENTIFIER --show-cache-node-info | sed -n -e 's/.*"Address": "//p' | sed -n -e 's/"//p' | tail -n -1

  
### Delete a Stack

1. Go to the [CloudFormation stack listing page](https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks?filter=active)
2. Select the stack to delete - *DO NOT PICK AN "AWS Elastic Beanstalk..." stack* - these are special, autogenerated child stacks. Pick a named Stack.
3. Click "Delete Stack" and confirm. 



